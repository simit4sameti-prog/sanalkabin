import React, { useState } from 'react';
import { Upload, X, Camera, Shirt, Sparkles, Download, RefreshCw, AlertCircle, User, Plus, Trash2, History } from 'lucide-react';

export default function App() {
  const [userImage, setUserImage] = useState(null);
  
  // Gardırop State'i (Birden fazla kıyafet)
  const [wardrobe, setWardrobe] = useState([]); 
  const [selectedClothIndex, setSelectedClothIndex] = useState(null);
  
  // Sonuç ve Geçmiş State'i
  const [generatedImage, setGeneratedImage] = useState(null);
  const [history, setHistory] = useState([]); // { id, result, clothId }
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleUserUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setUserImage(event.target.result);
        setGeneratedImage(null);
        setError(null);
      };
      reader.readAsDataURL(file);
    }
  };

  // GÜNCELLENEN FONKSİYON: Çoklu dosya yükleme desteği
  const handleClothUpload = (e) => {
    const files = Array.from(e.target.files); // Seçilen tüm dosyaları diziye çevir
    
    if (files.length > 0) {
      // Her bir dosyayı okuyup gardıroba ekle
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const newCloth = {
            id: Date.now() + Math.random(), // Çakışmayı önlemek için random ekledik
            src: event.target.result
          };
          setWardrobe(prev => {
            const updated = [...prev, newCloth];
            // Eğer hiç seçim yoksa, ilk yükleneni veya sonuncuyu seçili yapabiliriz
            // Burada kullanıcıya bırakıyoruz, otomatik seçim yapmıyoruz ki karışmasın
            return updated;
          });
        };
        reader.readAsDataURL(file);
      });
      
      // İlk kıyafet eklendiğinde otomatik seçim mantığı (opsiyonel)
      if (selectedClothIndex === null) {
         // setSelectedClothIndex(wardrobe.length); 
      }
      
      setError(null);
    }
  };

  const removeCloth = (e, index) => {
    e.stopPropagation();
    const newWardrobe = wardrobe.filter((_, i) => i !== index);
    setWardrobe(newWardrobe);
    if (selectedClothIndex === index) setSelectedClothIndex(null);
    if (selectedClothIndex > index) setSelectedClothIndex(selectedClothIndex - 1);
  };

  const generateTryOn = async () => {
    if (!userImage || selectedClothIndex === null) return;

    setLoading(true);
    setError(null);
    
    try {
      const currentCloth = wardrobe[selectedClothIndex];
      const userBase64 = userImage.split(',')[1];
      const clothBase64 = currentCloth.src.split(',')[1];

      const apiKey = ""; // Runtime tarafından sağlanır

      const prompt = `
        You are an expert AI Fashion Stylist with advanced image manipulation skills.
        I have provided two images:
        1. A photo of a person (Target).
        2. A photo of a clothing item (Source Garment).

        OBJECTIVE:
        Realistically dress the person in the source garment, replacing their current outfit.

        CRITICAL INSTRUCTIONS & EXECUTION STEPS:
        1. **Preserve Identity (STRICT):** The person's face, hair, head shape, skin tone, and body pose must remain UNTOUCHED and EXACTLY as in the original photo. Do not distort the face.
        2. **Perfect Fit & Warping:** Analyze the person's body pose (sitting, standing, angled). Warp and adjust the source garment to fit the person's body geometry naturally. It should not look like a flat sticker.
        3. **Physics & Lighting:** Apply realistic fabric physics. Add wrinkles, drapes, and folds where the fabric naturally bends on the body. Match the lighting, shadows, and color tone of the garment to the person's environment.
        4. **Texture Fidelity:** Maintain the high-resolution details, patterns, logos, and texture of the source garment. Do not change the design of the clothing.
        5. **Seamless Blending:** The boundary between the garment and the skin (neck, arms, waist) must be seamless and artifact-free. Completely remove the original clothing underneath.
        
        OUTPUT:
        Generate a single, high-quality, photorealistic fashion image.
      `;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inlineData: { mimeType: "image/jpeg", data: userBase64 } },
                { inlineData: { mimeType: "image/jpeg", data: clothBase64 } }
              ]
            }],
            generationConfig: {
              responseModalities: ["IMAGE"],
            }
          })
        }
      );

      if (!response.ok) {
        throw new Error('Yapay zeka servisine ulaşılamadı.');
      }

      const result = await response.json();
      const candidates = result.candidates;
      
      if (candidates && candidates.length > 0) {
        const parts = candidates[0].content.parts;
        const imagePart = parts.find(p => p.inlineData);
        
        if (imagePart) {
           const finalImageUrl = `data:image/jpeg;base64,${imagePart.inlineData.data}`;
           setGeneratedImage(finalImageUrl);
           
           setHistory(prev => [
             { id: Date.now(), result: finalImageUrl, clothId: currentCloth.id },
             ...prev
           ]);
        } else {
           throw new Error("Görsel oluşturulamadı.");
        }
      } else {
        throw new Error("Beklenmedik bir hata oluştu.");
      }

    } catch (err) {
      console.error(err);
      setError("İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.");
    } finally {
      setLoading(false);
    }
  };

  const downloadImage = (imgSrc) => {
    const link = document.createElement('a');
    link.href = imgSrc || generatedImage;
    link.download = `ai-kabin-${Date.now()}.jpg`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-slate-50 text-gray-800 font-sans selection:bg-indigo-100 flex flex-col">
      
      {/* Header */}
      <header className="bg-white border-b border-gray-200 py-3 px-6 sticky top-0 z-20 shadow-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md">
              <Sparkles size={18} />
            </div>
            <h1 className="text-lg font-bold text-gray-900">AI Gardırop</h1>
          </div>
          <div className="flex items-center gap-3">
             <div className="text-xs text-gray-500 hidden sm:block">
                Gemini 2.5 Flash ile Güçlendirildi
             </div>
          </div>
        </div>
      </header>

      <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* SOL PANEL: GİRDİLER */}
        <div className="lg:col-span-4 space-y-5 overflow-y-auto max-h-[calc(100vh-100px)] scrollbar-hide">
          
          {/* 1. Kullanıcı Bölümü */}
          <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                <User size={16} className="text-indigo-500" />
                Senin Fotoğrafın
              </h2>
              {userImage && <button onClick={() => setUserImage(null)} className="text-gray-400 hover:text-red-500"><X size={16}/></button>}
            </div>

            {!userImage ? (
              <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-200 rounded-xl cursor-pointer bg-gray-50 hover:bg-indigo-50 hover:border-indigo-300 transition-all group">
                <Camera className="w-8 h-8 text-indigo-300 mb-2 group-hover:scale-110 transition-transform" />
                <span className="text-xs font-medium text-gray-500">Fotoğraf Ekle</span>
                <input type="file" className="hidden" accept="image/*" onChange={handleUserUpload} />
              </label>
            ) : (
              <div className="relative rounded-xl overflow-hidden h-48 bg-gray-100 ring-1 ring-gray-200">
                <img src={userImage} alt="User" className="w-full h-full object-cover" />
              </div>
            )}
          </div>

          {/* 2. Gardırop Bölümü (Çoklu Seçim) */}
          <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
             <div className="flex items-center justify-between mb-3">
              <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                <Shirt size={16} className="text-pink-500" />
                Gardırop
              </h2>
              <span className="text-xs text-gray-400">{wardrobe.length} parça</span>
            </div>

            {/* Kıyafet Ekleme Butonu (GÜNCELLENDİ: multiple özelliği eklendi) */}
            <label className="flex items-center justify-center w-full py-3 mb-4 border-2 border-dashed border-gray-200 rounded-xl cursor-pointer bg-gray-50 hover:bg-pink-50 hover:border-pink-300 transition-all text-gray-500 hover:text-pink-600 gap-2">
              <Plus size={18} />
              <span className="text-sm font-medium">Yeni Kıyafet Ekle (Çoklu Seçim)</span>
              {/* multiple prop'u eklendi */}
              <input type="file" className="hidden" accept="image/*" multiple onChange={handleClothUpload} />
            </label>

            {/* Kıyafet Listesi Grid */}
            {wardrobe.length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {wardrobe.map((cloth, idx) => (
                  <div 
                    key={cloth.id}
                    onClick={() => setSelectedClothIndex(idx)}
                    className={`relative rounded-xl overflow-hidden aspect-square border-2 cursor-pointer transition-all group
                      ${selectedClothIndex === idx 
                        ? 'border-pink-500 shadow-md ring-2 ring-pink-200' 
                        : 'border-gray-100 hover:border-pink-200'}`}
                  >
                    <img src={cloth.src} alt={`Cloth ${idx}`} className="w-full h-full object-contain p-2 bg-white" />
                    
                    {/* Seçili İkonu */}
                    {selectedClothIndex === idx && (
                      <div className="absolute top-2 left-2 w-5 h-5 bg-pink-500 rounded-full flex items-center justify-center text-white text-[10px]">
                        ✓
                      </div>
                    )}

                    {/* Silme Butonu */}
                    <button 
                      onClick={(e) => removeCloth(e, idx)}
                      className="absolute top-2 right-2 p-1.5 bg-white/80 rounded-full text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                    >
                      <Trash2 size={12} />
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-400 text-xs">
                Henüz kıyafet eklenmedi.
              </div>
            )}
          </div>

          {/* İşlem Butonu */}
          <button
            onClick={generateTryOn}
            disabled={!userImage || selectedClothIndex === null || loading}
            className={`w-full py-3.5 px-6 rounded-xl flex items-center justify-center gap-2 font-bold text-sm shadow-lg transition-all transform active:scale-95
              ${!userImage || selectedClothIndex === null
                ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                : loading 
                  ? 'bg-indigo-400 text-white cursor-wait'
                  : 'bg-indigo-600 text-white hover:bg-indigo-700'
              }`}
          >
            {loading ? (
              <>
                <RefreshCw className="animate-spin w-4 h-4" />
                Hazırlanıyor...
              </>
            ) : (
              <>
                <Sparkles className="w-4 h-4" />
                {wardrobe.length > 0 && selectedClothIndex !== null 
                  ? "Seçili Kıyafeti Dene" 
                  : "Kıyafet Seçin"}
              </>
            )}
          </button>
          
          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs border border-red-100">
              {error}
            </div>
          )}
        </div>

        {/* SAĞ PANEL: SONUÇ VE KARŞILAŞTIRMA */}
        <div className="lg:col-span-8 flex flex-col gap-4 h-full">
          
          {/* Ana Sonuç Alanı */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-200 flex-1 relative overflow-hidden flex flex-col min-h-[400px]">
            <div className="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
              <span className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                <Sparkles size={14} />
                Önizleme
              </span>
              {generatedImage && (
                <button 
                  onClick={() => downloadImage(generatedImage)}
                  className="flex items-center gap-1 px-3 py-1.5 bg-gray-800 text-white text-xs font-medium rounded-lg hover:bg-black transition-colors"
                >
                  <Download size={14} />
                  İndir
                </button>
              )}
            </div>
            
            <div className="flex-1 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-gray-50 flex items-center justify-center p-4 relative">
              {loading ? (
                 <div className="text-center">
                    <div className="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div>
                    <p className="text-sm font-medium text-gray-600">Yapay Zeka Çalışıyor...</p>
                 </div>
              ) : generatedImage ? (
                <img src={generatedImage} alt="Result" className="max-w-full max-h-[60vh] object-contain shadow-2xl rounded-lg animate-in fade-in zoom-in duration-300" />
              ) : (
                <div className="text-center opacity-40">
                  <div className="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-3 flex items-center justify-center">
                    <User size={32} className="text-gray-400" />
                  </div>
                  <p className="text-sm text-gray-500">Sonuç burada görünecek</p>
                </div>
              )}
            </div>
          </div>

          {/* Karşılaştırma / Geçmiş Şeridi */}
          {history.length > 0 && (
            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4">
              <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <History size={14} />
                Karşılaştırma Geçmişi
              </h3>
              <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                {history.map((item) => (
                  <div 
                    key={item.id} 
                    onClick={() => setGeneratedImage(item.result)}
                    className={`relative flex-shrink-0 w-24 h-32 rounded-lg overflow-hidden border-2 cursor-pointer transition-all hover:scale-105
                      ${generatedImage === item.result ? 'border-indigo-500 ring-2 ring-indigo-200' : 'border-gray-100'}`}
                  >
                    <img src={item.result} alt="History" className="w-full h-full object-cover" />
                    {/* Hangi kıyafet olduğunu gösteren minik rozet */}
                    <div className="absolute bottom-1 right-1 w-6 h-6 rounded-full border border-white overflow-hidden shadow-sm bg-white">
                         {(() => {
                            const cloth = wardrobe.find(c => c.id === item.clothId);
                            return cloth ? <img src={cloth.src} className="w-full h-full object-contain" /> : null;
                         })()}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

        </div>
      </main>
    </div>
  );
}
